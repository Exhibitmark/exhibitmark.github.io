<html class="dark" lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" href="/favicon.ico">
    <title>GHST Submit</title>
    <link href="./main.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        .red {
            color:#e61748;
        }
        .red-border {
            border-color:#e61748 !important;
        }
        .blue {
            color:#6769eb;
        }
        .blue-bg {
            background-color:#6769eb;
        }
        .hidden {
            display:none;
        }
        .justify-end {
            justify-content: flex-end;
        }
        .disabled {
            pointer-events: none;
            background-color:#25242b ;
            color:#ffffff4f
        }

        
    </style>
</head>

<body class="main">
    <div id="app">
        <div>
            <div class="flex">
                <nav class="side-nav">
                    <a href="/" class="router-link-active intro-x flex items-center pl-5 pt-4">
                        <img style="width:4rem" src="./logo.png">
                    </a>
                    <div class="side-nav__devider my-6"></div>
                    <ul>
                        <li>
                            <a href="./speedruns.html" class="side-menu">
                                <div class="side-menu__icon"></div>
                                <div class="side-menu__title">Leaderboard</div>
                            </a>
                        </li>
                        <li>
                            <a href="./speedrun_submit.html" style="background-color:#e8e8e8 ;"  class="side-menu">
                                <div style="color:#6769eb; font-weight:600" class="side-menu__title">Submit Run</div>
                            </a>
                        </li>
                        <li>
                            <a href="./rules.html" class="side-menu">
                                <div class="side-menu__title">Rules</div>
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="content">
                    <!--TOP BAR COMMENTED OUT-->
                    <!--<div class="top-bar"></div>-->
                    <!--MAIN CONTENT-->
                    <div>
                        <div class="intro-y col-span-12 flex flex-wrap sm:flex-nowrap items-center mt-2">
                            <h2 id="leaderboard_title" class="intro-y text-lg font-medium mt-10">GHST Run Submission</h2>
                            <div class="w-full sm:w-auto mt-3 sm:mt-0 sm:ml-auto">
                                <div style="display:flex" class="w-56 relative text-gray-700 dark:text-gray-300 justify-end">
                                    <h3 id="status" class="intro-y text-sm font-medium mt-10 red">Server Loading</h3>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="grid grid-cols-12 gap-6 mt-5">
                                <div class="intro-y col-span-12">
                                    <div class="intro-y box p-5">
                                        <div>
                                            <label for="crud-form-1" class="form-label">Gamertag</label>
                                            <input autocomplete="off" id="gamertag" type="text" class="form-control w-full" placeholder="ex. Gary UK (max 16 characters)">
                                        </div>
                                        <div class="mt-5">
                                            <label for="crud-form-2-tomselected" class="form-label" id="crud-form-2-ts-label">Map</label>
    
                                            <div class="flex flex-col sm:flex-row items-center">
                                                <select autocomplete="off" id="maps" class="form-select form-select-lg sm:mt-2 sm:mr-2" aria-label=".form-select-lg example">
                                                    <option value="" disabled selected>Select your map</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mt-5">
                                            <label for="crud-form-3" class="form-label">Video URL (Youtube links only)</label>
                                            <div class="input-group">
                                                <input autocomplete="off" id="link" type="text" class="form-control" placeholder="ex.https://www.youtube.com/watch?v=eoV-2YCQhm4">
                                            </div>
                                        </div>
                                        <div class="mt-5"><label class="form-label">Time</label>
                                            <div class="sm:grid grid-cols-4 gap-2">
                                                <div class="input-group">
                                                    <div id="input-group-3" class="input-group-text">HH</div>
                                                    <input id="hour" autocomplete="off"  type="number" class="form-control" placeholder="Hours" min="0" max="24">
                                                </div>
                                                <div class="input-group mt-2 sm:mt-0">
                                                    <div id="input-group-4" class="input-group-text">MM</div>
                                                    <input  id="minute" autocomplete="off"  type="number" class="form-control" placeholder="Minutes" min="0" max="60">
                                                </div>
                                                <div class="input-group mt-2 sm:mt-0">
                                                    <div id="input-group-4" class="input-group-text">SS</div>
                                                    <input  id="second" autocomplete="off"  type="number" class="form-control" placeholder="Seconds" min="0" max="60">
                                                </div>
                                                <div class="input-group mt-2 sm:mt-0">
                                                    <div id="input-group-4" class="input-group-text">MS</div>
                                                    <input id="millisecond" autocomplete="off" type="number" class="form-control" placeholder="Milliseconds" min="0" max="1000">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right mt-8">
                                            <button id="submit" type="button" class="btn disabled blue-bg w-24">Submit</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const submit = {
            "map":null,
            "gamertag":null,
            "link": null,
            "hour":null,
            "minute":null,
            "second":null,
            "millisecond":null
        }

        $(".form-control").change(function(e){
            let id = e.target.id;
            let val = e.target.value;
            submit[id] = val
            checkFields()
        })

        get(`https://acute-ginger-appeal.glitch.me/submit_info`, build)

        function get(url,cb){
            $('#status').removeClass('blue')
            fetch(url)
                .then(response => response.json())
                .then(commits => {
                    $('#status').toggleClass('blue').text('Server Online')
                    cb(commits,url)
                });
        }

        function linkParse(url){
            let regExp = /^https?\:\/\/(?:www\.youtube(?:\-nocookie)?\.com\/|m\.youtube\.com\/|youtube\.com\/)?(?:ytscreeningroom\?vi?=|youtu\.be\/|vi?\/|user\/.+\/u\/\w{1,2}\/|embed\/|watch\?(?:.*\&)?vi?=|\&vi?=|\?(?:.*\&)?vi?=)([^#\&\?\n\/<>"']*)/i;
            let match = url.match(regExp);
            return (match && match[1].length==11)? match[1] : null;
        }

        function build(data){
            let select = document.getElementById('maps');
            data.forEach((e, i) => {
                let opt = document.createElement('option');
                opt.value = e[0];
                opt.innerHTML = e[0];
                opt.id = e[1]
                select.appendChild(opt);
            });

            $('select').click(function(e){
                if(e.target.id !== 'map'){
                    submit.map = e.target.id
                }
                checkFields()
            });
        }
        $('#submit').click(function(e){
            submit.gamertag = submit.gamertag.slice(0,16)
            post("https://acute-ginger-appeal.glitch.me/add_record", JSON.stringify(submit))
        });

        function post(url, data) {
            fetch(url, {
                method: "POST", 
                body: data,
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then((response) => {
                response.json().then((data) => {
                    if(data.status == 'error'){
                        console.log(data.status)
                    }
                });
            });
        }

        //More checks are done on the server, these are just to know whether to throw an error before submitting incorrect data.
        function checkFields(){
            let fields = Object.values(submit)
            if(submit.link !== null){
                if(linkParse(submit.link) == null){
                    $('#submit').addClass('disabled')
                    $('#link').addClass('red-border')
                } else{
                    $('#link').removeClass('red-border')
                }
            }
            if(!fields.includes(null)){
                
                $('#submit').toggleClass('disabled')
                return false
            }
            if(submit.map == null){
                $('#maps').addClass('red-border')
            } else{
                $('#maps').removeClass('red-border')
            }
            return true
        }

        function build_map(data, url){
            let d = data.records
            
            $('#leaderboard_title').text(data.name + " Leaderboard")
            $("#table_header").empty();
            $( "#table_body" ).empty();
            
            $( "#table_header" ).prepend(mapTableHeader()); 
            Object.keys(d).forEach((e, i) => {
                $( "#table_body" ).append(recordItem(d[e],i)); 
            });
        }

        function msToTime(s) {
            // Pad to 2 or 3 digits, default is 2
            function pad(n, z) {
            z = z || 2;
            return ('00' + n).slice(-z);
            }

            var ms = s % 1000;
            s = (s - ms) / 1000;
            var secs = s % 60;
            s = (s - secs) / 60;
            var mins = s % 60;
            var hrs = (s - mins) / 60;

            return pad(hrs) + ':' + pad(mins) + ':' + pad(secs) + '.' + pad(ms, 2);
        }

    </script>
</body>
</html>